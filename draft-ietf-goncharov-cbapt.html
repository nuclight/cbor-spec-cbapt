<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>CBOR &amp; generic BLOB Atoms, Packing and Templating</title>
<meta content="Vadim Goncharov" name="author">
<meta content='
       The Concise Binary Object Representation (CBOR, RFC 8949 == STD 94)
is a data format whose design goals include the possibility of
extremely small code size, fairly small message size, and
extensibility without the need for version negotiation. 
       CBOR does not provide any forms of data compression.
While
traditional data compression techniques such as DEFLATE (RFC 1951)
can work well for CBOR encoded data items, their disadvantage is that
the recipient needs to decompress the compressed form to make use of
the data.
Moreover, there are sutuations where utilizing some application-known dictionary at a "preprocessing" can improve compression effectiveness of methods such as DEFLATE even in non-constrained environments (e.g. by not polluting compression window by known data). 
       Also, there are tasks where known document ("template") may be instantiated by substituting different "variables" into it each time.
At the same time, both compression and templating may be needed by some applications not only for CBOR documents, but also for unstructured raw BLOBs. 
       This documents defines format for compression and templating of both raw BLOBs and CBOR documents by concept of "atom". 
       The CBAPT is a subset of the more general CBOR-TPL (Templating &amp; Programming Language, separate specification) suitable to use by constrained devices. 
    ' name="description">
<meta content="xml2rfc 3.30.2" name="generator">
<meta content="compression" name="keyword">
<meta content="templating" name="keyword">
<meta content="CBOR" name="keyword">
<meta content="draft-ietf-goncharov-cbapt-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.30.2
    Python 3.12.11
    ConfigArgParse 1.7
    google-i18n-address 3.1.1
    intervaltree 3.1.0
    Jinja2 3.1.6
    lxml 5.3.1
    platformdirs 4.4.0
    pycountry 24.6.1
    PyYAML 6.0.2
    requests 2.32.5
    setuptools 80.9.0
    wcwidth 0.2.14
-->
<link href="draft-ietf-goncharov-cbapt.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-cyrillic.woff2') format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-greek.woff2') format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-greek.woff2') format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  --font-title: "Sofia Sans Semi Condensed", sans-serif;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
section {
  clear: both;
}
.section-number {
  padding-right: 0.5em;
}
h1, h2, h3, h4, h5, h6 {
  font-family: var(--font-title);
  font-weight: 680;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
  vertical-align: top;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
  & :is(ol, ul) {
    margin-left: 1em;
  }
}
li {
  margin: 0 0 0.25em 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
  & li {
    margin-top: 0.5em;
  }
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  margin: 0 0 0 2em;
  & li {
    margin: 0;
    & :first-child { margin-top: 0; }
    & :last-child { margin-bottom: 0; }
  }
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
  &.olPercent {
    --indent: 5ch;
    & > dt {
      min-width: calc(var(--indent) - 2ch);
    }
  }
  &.olPercent > dt {
    float: none;
  }

  dl > dd > & {
    margin-top: 0.5em;
    margin-bottom: 0;
  }
}
dl:not(.dlNewline) > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
  & > :is(:first-child, .break:first-child + *) {
    margin-top: 0;
  }
  & > :is(:last-child) {
    margin-bottom: 0;
  }
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
  caption-side: bottom;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    /* In the horizontal direction, sometimes people make over-sized figures.
       Scrollbars for those is therefore necessary: auto adds them as necessary..
       In the vertical direction, the line-height can combine with the font
       asender/descender height to produce scrollbars: hidden avoids that. */
    overflow: auto hidden;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: auto;
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
  &[href] {
    color: var(--pilcrow-weak);
    &:hover { text-decoration: none; }
  }
}
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
  & dt {
    width: var(--identifier-width);
    min-width: var(--identifier-width);
    clear: left;
    float: left;
    text-align: right;
    margin-right: 1ch;
  }
  & dd {
    margin: 0;
    margin-left: calc(1em + var(--identifier-width)) !important;
    min-width: 5em;
  }
  & .authors {
    & .author {
      display: inline-block;
      margin-right: 1.5em;
    }
    & .org {
      font-style: italic;
    }
  }
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;

  & nav {
    & ul {
      margin: 0 0.5em 0 0;
      padding: 0;
      list-style: none;
    }
    & li {
      line-height: 1.3em;
      margin: 2px 0;
      padding-left: 1.2em;
      text-indent: -1.2em;
    }
  }
  & a.xref {
    white-space: normal;
  }
}

.references {
  & > dt {
    text-align: right;
    font-weight: bold;
    min-width: 10ch;
    margin-right: 1.5ch;
    &:target::before {
      content: "⇒";
      margin: 0 10px 0 -25px;
    }
  }
  & > dd {
    margin-left: 12ch !important;
    overflow: visible;
    & .refInstance {
      margin-bottom: 0.8em;
    }
    & .ascii {
      margin-bottom: 0.25em;
    }
  }
}

#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  max-width: 20em;
  margin: 1em auto 1em 0;

  & .nameRole {
    font-weight: 700;
    margin-left: 0;
  }
  & .label {
    margin: 0.5em 0;
  }
  & .type {
    display: none;
  }
  & .alternative-contact {
    margin: 0.5em 0 0.25em 0;
  }
  & .non-ascii {
    margin: 0 0 0 2em;
  }
  & div.left {
    text-align: left;
  }
  & div.right {
    text-align: right;
  }
}

hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

/* Comments */
.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}

@media screen {
  #toc nav {
    font-family: var(--font-title);
    font-weight: 360;
    & > ul { margin-bottom: 2em; }
    & ul {
      margin: 0 0 0 4px;
      & :is(p, li) {
        margin: 2px 0;
      }
    }
  }
  #toc a.toplink {
    float: right;
  }
}
@media not screen {
  #toc a.toplink {
    display: none;
  }
}


/* TOC layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
    &::before { /* css hamburger */
      float: right;
      position: relative;
      width: 1em;
      height: 1px;
      left: -164px;
      margin: 8px 0 0 0;
      background: white none repeat scroll 0 0;
      box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
      content: "";
    }
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active {
    opacity: 1;
    & nav { display: block; }
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:is(:link, :focus, :hover),
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin: 2px 0.5em 0;
  }
}

/* TOC layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
  #toc a.toplink {
    margin: 8px 0.5em 0;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">CBAPT</td>
<td class="right">October 2025</td>
</tr></thead>
<tfoot><tr>
<td class="left">Goncharov</td>
<td class="center">Expires 19 April 2026</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-goncharov-cbapt-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2025-10-16" class="published">16 October 2025</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2026-04-19">19 April 2026</time></dd>
<dt class="label-authors">Author:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">V. Goncharov</div>
<div class="org">Consultant</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">CBOR &amp; generic BLOB Atoms, Packing and Templating</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">The Concise Binary Object Representation (CBOR, RFC 8949 == STD 94)
is a data format whose design goals include the possibility of
extremely small code size, fairly small message size, and
extensibility without the need for version negotiation.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
<p id="section-abstract-2">CBOR does not provide any forms of data compression.
While
traditional data compression techniques such as DEFLATE (RFC 1951)
can work well for CBOR encoded data items, their disadvantage is that
the recipient needs to decompress the compressed form to make use of
the data.
Moreover, there are sutuations where utilizing some application-known dictionary at a "preprocessing" can improve compression effectiveness of methods such as DEFLATE even in non-constrained environments (e.g. by not polluting compression window by known data).<a href="#section-abstract-2" class="pilcrow">¶</a></p>
<p id="section-abstract-3">Also, there are tasks where known document ("template") may be instantiated by substituting different "variables" into it each time.
At the same time, both compression and templating may be needed by some applications not only for CBOR documents, but also for unstructured raw BLOBs.<a href="#section-abstract-3" class="pilcrow">¶</a></p>
<p id="section-abstract-4">This documents defines format for compression and templating of both raw BLOBs and CBOR documents by concept of "atom".<a href="#section-abstract-4" class="pilcrow">¶</a></p>
<p id="section-abstract-5">The CBAPT is a subset of the more general CBOR-TPL (Templating &amp; Programming Language, separate specification) suitable to use by constrained devices.<a href="#section-abstract-5" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://nuclight.github.io/cbor-spec-cbapt/draft-ietf-goncharov-cbapt.html">https://nuclight.github.io/cbor-spec-cbapt/draft-ietf-goncharov-cbapt.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-ietf-goncharov-cbapt/">https://datatracker.ietf.org/doc/draft-ietf-goncharov-cbapt/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/nuclight/cbor-spec-cbapt">https://github.com/nuclight/cbor-spec-cbapt</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 19 April 2026.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2025 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1" class="keepWithNext"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-main-text" class="internal xref">Main text</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-address" class="internal xref">Author's Address</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">TODO Introduction<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">TODO source with history of thinking process lives at https://github.com/nuclight/musctp/blob/main/cbar.txt<a href="#section-1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-2.1">
          <p id="section-2-2.1.1">CBAR (CBOR and generic BLOBs by-Atom Reducing) - format of binary string<a href="#section-2-2.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="main-text">
<section id="section-3">
      <h2 id="name-main-text">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-main-text" class="section-name selfRef">Main text</a>
      </h2>
<p id="section-3-1">TODO adapt from CBAR<a href="#section-3-1" class="pilcrow">¶</a></p>
<p id="section-3-2">This is a format for compression of both unstructured raw BLOBs and CBOR
  documents by concept of "atom" (see Lisp and X11 windowing system) - a short
  integer used instead of (probably very) long string. A set of atoms, that
  is, mapping between integers and strings, is called "dictionary" here, using
  "just" this word (there is also "byte dictionary" meaning a pre-supplied
  block of bytes to compressors supporting it, like zlib or zstd). Reason for
  using atoms is that such strings are typically already present in
  (constrained) implementation's memory (as opposed to byte dictionary). CBAR
  provides facilities for dictionary management: as different CBOR documents
  will require different sets of atoms for better compression, dictionaries
  can be referenced from outside, changed on the fly throughout document, etc.<a href="#section-3-2" class="pilcrow">¶</a></p>
<p id="section-3-3">-- as this "draft of draft" is currently being discussed in comparison to
   [draft-ietf-cbor-packed], it is currently terse, assuming reader at least
   barely familiar with things discussed in CBOR WG mailing list and
   cbor-packed draft<a href="#section-3-3" class="pilcrow">¶</a></p>
<p id="section-3-4">Dictionary management is not something was consistently done through
  IETF protocols yet. JSON-LD did a good work, through using "@context", but
  it focused mainly on human readability and editability, rather than on
  compression. RADIUS protocol had something similar to atoms in the sense of
  integer mapping to strings, but dictionary had to be set up manually by
  network administrator matching on both sides. YANG in CBOR used concept of
  SID, while simple to implement, avoiding dictionary management at all - it
  is globally unique and "set in stone" forever, even if specification is
  later corrected or withdrawn, thus reducing possible compression ratio.
  Moreover, current specification does not attempt to compress YANG bits
  (tag #6.43), while CBAR capable to do it. And CBOR-LD draft, as of end of
  December 2024, did not proceed to clear architecture or at least adequately
  readable specification, while trying to allocate rather large set of tags
  (see e.g. [https://github.com/json-ld/cbor-ld-spec/issues/38]), so there are
  good chances that CBOR-LD could be instead replaced by small specification
  on top of CBAR about exact format of dictionary references (e.g. register
  a tag) and how to interpret retrieved content from them to CBAR needs.<a href="#section-3-4" class="pilcrow">¶</a></p>
<p id="section-3-5">Moreover, even ASN.1/X.509/RFC 9090 examples could be reduced by CBAR, e.g.
  example their about "buildingName (0.9.2342.19200300.100.1.48)" encoding is
  longer than would be typical atom, and for other 3 byte examples chances are
  atom could be 2 bytes.<a href="#section-3-5" class="pilcrow">¶</a></p>
<p id="section-3-6">The format is described in terms of unpacker copying data from input to
  target unpacked CBOR which later can be feed to generic CBOR decoder,
  however, it is possible, though hard, to implement in-place access to
  CBAR data (like in draft-cbor-packed), if application wish so and is
  constrained in RAM but not ROM. Thus, CBAR is designed so it does not
  prohibit such implementation directly in CBOR decoder - however,
  implementers are warned that this is error-prone. In other words, CBAR can
  be viewed as a simple templating mechanism for CBOR like a POSIX Shell could
  be used as a simple templating mechanism for text: that is, a text is
  a sequence of variable assignments and variable substitutions, possibly
  utilizing previous variables, and so on.<a href="#section-3-6" class="pilcrow">¶</a></p>
<p id="section-3-7">In-place access to CBAR (and in-place access in cbor-packed), however, is
  analogous to POSIX Make(1) utility - where variable expansion is deferred
  until actual use, often requiring to track them recursively - which is
  frequently hard to maintain even for human dealing with text Makefiles,
  implementing it "like make" for binary format can be even harder.<a href="#section-3-7" class="pilcrow">¶</a></p>
<p id="section-3-8">CBAR allows for dictionary setup both outside of CBOR document (the main
  value is that atoms don't need to be passed with each application message)
  and inside, both as part of CBOR structure, or pre-setup - e.g. as CBOR
  sequence previous to current one.<a href="#section-3-8" class="pilcrow">¶</a></p>
<p id="section-3-9">An (incomplete) CDDL for CBAR is shown here as a brief overview. As most of
  this documents deal with raw bytes, not everything could be expressed as
  CDDL and/or EDN so it wasn't polished/corrected.<a href="#section-3-9" class="pilcrow">¶</a></p>
<p id="section-3-10">```
   CBAR-CBOR = #6.10([atoms, bytedict, CBAR, ? checksum])  ; 0x0a for "Atom"
             / #6.10([ (+ commands), CBAR, ? checksum])    ; full form
             / #6.10(CBAR)    ; binary string - everything other setup earlier<a href="#section-3-10" class="pilcrow">¶</a></p>
<p id="section-3-11">atomarr = [ + atom ]       ; "atom" is like in X11 sense - number of string
   atom = bstr                ; raw value
        / tstr                ; contents as raw value
        / #6.10(bstr)         ; itself CBAR - definition uses previous atoms
        / any                 ; valid CBOR fragment to substitute<a href="#section-3-11" class="pilcrow">¶</a></p>
<p id="section-3-12">atoms = atomarr / uint / bstr,    ; atoms array (mb empty) or their hash
   bytedict = bstr / uint,           ; byte dictionary (mb empty) or it's hash
   CBAR = null / bstr .size (3..),   ; may have e.g. 40003 tag if DEFLATE'd
   checksum = uint
```<a href="#section-3-12" class="pilcrow">¶</a></p>
<p id="section-3-13">In atom definitions, each definition <span class="bcp14">MUST</span> use only prior atom numbers if
  it's CBAR itself (that is, defined with #6.10 tag).<a href="#section-3-13" class="pilcrow">¶</a></p>
<p id="section-3-14">An atom <span class="bcp14">MUST</span> be for a string with at least 3 bytes long, and representation
  of atom <span class="bcp14">SHOULD</span> be shorter than string itself (or compression will not be
  achieved, leaving just templating).<a href="#section-3-14" class="pilcrow">¶</a></p>
<p id="section-3-15">TBD use 22098 for recursive "after unpacking, there are more CBAR inside"?<a href="#section-3-15" class="pilcrow">¶</a></p>
<p id="section-3-16">## Model of operation.<a href="#section-3-16" class="pilcrow">¶</a></p>
<p id="section-3-17">Encoder and decoder are described here in object-oriented terms, though
  implementation is not obliged to be OO-style. At some point, new object is
  instantiated (constructor called), on which methods could be called, either
  for settings (e.g. canonical mode) or for actual CBOR processing. From this
  specification's point of view, a decoder object holds state needed for
  unpacking, that is, primarily dictionaries of atoms. This state could be
  modified by application calling methods on object, outside of any CBOR
  processing, and thus CBAR information is defined in such way that is
  equivalent to "in-band" calling of such state-modifying methods.<a href="#section-3-17" class="pilcrow">¶</a></p>
<p id="section-3-18">A generalized view of application protocol is ordered sequence of messages
  decoded (or a sub-sequence if partial ordered):<a href="#section-3-18" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-19">
<pre>
new()       Message 1                   Message 2
  |      .-------------.     .----------------------------.
  |      | CBOR Item 1 |     |        CBOR Sequence       |
  |      |             |     |-------------+--------------|
  |      |             |     | CBOR Item 1 | CBOR Item 2  |
  |-----&gt;|             |----&gt;|             |              |----&gt; ...
  |      |             |     |             | {      lvl 1 |
  |      |             |     |             |   [    lvl 2 |
  |      |             |     |             |     {  lvl 3 |
  |      |             |     |             |     },       |
  |      |             |     |             |     s, lvl 2 |
        `-------------'     `-------------+--------------'
</pre><a href="#section-3-19" class="pilcrow">¶</a>
</div>
<p id="section-3-20">However, observe that generic decoder does not need to know application
  messages' boundaries - to support CBOR Sequences, it is enough for decoder
  to have methods e.g. <code>decode()</code> and <code>decode_prefix()</code> both accepting buffer
  with bytes (e.g. pointer and length), where former method expects entire
  buffer consists of complete CBOR item and latter decodes complete CBOR item
  returning number of bytes consumed from buffer (note such interface is
  unified for both CBOR Sequences and incremental parsing of partially
  received stream).<a href="#section-3-20" class="pilcrow">¶</a></p>
<p id="section-3-21">Thus, for decoder the diagram above is in fact equivalent to single message
  with three CBOR sequences or 3 messages - it's merely for application where
  it may call additional methods after the initial <code>new()</code> constructor and
  settings methods.<a href="#section-3-21" class="pilcrow">¶</a></p>
<p id="section-3-22">CBAR is intended to be used in scenarios where packing information is known
  beforehand, so it is possible to achieve better compression by not including
  dictionary in each CBOR message, but provide it out of band. Of course, full
  support of inline (in CBOR stream itself) dictionaries definition is
  supported, as well as multiple dictionaries and redefining them inside of
  complex CBOR structures - similar in spirit to JSON-LD's "@context"'s. On
  the diagram above there is map containg array containing other map and
  string, elements of outer map wuld have level 1 of nesting, elements of
  array are on level 2 (including string s), and elements in map in array
  would be on level 3. Thus, each top-level CBOR item could be viewed as being
  on level 0.<a href="#section-3-22" class="pilcrow">¶</a></p>
<p id="section-3-23">## Tag equivalence<a href="#section-3-23" class="pilcrow">¶</a></p>
<p id="section-3-24">This section borrows same chapter from [draft-cbor-packed] and extends it
  for CBAR in adding exceptions to generic rule for nested tags where it was
  equivalent to leave outer tag and replace inner tag with it's
  modified/substituted contents: for Tag #6.10, a tag following it (that is,
  inner to it) may be "modifier" to it. For example,<a href="#section-3-24" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-25">
<pre>
#6.10(#6.63("binary string"))
</pre><a href="#section-3-25" class="pilcrow">¶</a>
</div>
<p id="section-3-26">means that binary string after unpacking (with dictionary set up somewhere
  before) must be "substituted", omitting both tags, as CBOR elements in this
  place. If that binary string is to be left as is for application in unpacked
  CBOR, then just <code>#6.10("binary string")</code> is used. If application wants
  a binary string, just tagged as CBOR Sequence, then tag is moved out:<a href="#section-3-26" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-27">
<pre>
#6.63(#6.10("binary string")
</pre><a href="#section-3-27" class="pilcrow">¶</a>
</div>
<p id="section-3-28">TBD 10.01 02:40 or that tag could be just inside binary string itself?<a href="#section-3-28" class="pilcrow">¶</a></p>
<p id="section-3-29">TODO table of #6.10 sequences variants TBD where to put Alternatives if 63/24?
- 09.04.25 09:30 as YAML defines Tag to be URI, we can take URI idea that it
  can have ?query=part&amp;in=no&amp;particular=order<a href="#section-3-29" class="pilcrow">¶</a></p>
<p id="section-3-30">This way, tag #6.10 could be used just for binary strings unpacking, not
  altering CBOR tree structure at all - hence "B" in "CBAR" is for generic
  BLOBs. And both methods could be combined in same CBOR stream.<a href="#section-3-30" class="pilcrow">¶</a></p>
<p id="section-3-31">## Rules of Tag #6.10 substituitions<a href="#section-3-31" class="pilcrow">¶</a></p>
<p id="section-3-32">Example of substituting bare tag #6.10 for binary strings already was given
  (only to remind here is that inner tag 24 also could be used for complete
  CBOR item, not sequence). Tag #6.10 on an array where CBAR member is
  non-null is always expanded as complete CBOR item (unless CBAR member has
  tag #6.63 on it, then as sequence) - because it is useless to setup
  dictionary for just one binary string, so it's not supported.<a href="#section-3-32" class="pilcrow">¶</a></p>
<p id="section-3-33">TBD is it?<a href="#section-3-33" class="pilcrow">¶</a></p>
<p id="section-3-34">The other possible application of Tag #6.10 is on integers, where integer is
  atom number, expanding to a single string, with positive integers expanding
  to binary strings (Major Type 2) and negative to text strings (Major Type
  3)
TBD mnemonic is to add 2 to major type, but is it friendly?<a href="#section-3-34" class="pilcrow">¶</a></p>
<p id="section-3-35">TODO 23.01.25 #6.10(24(uint)) must expand to complete CBOR item
- 24.01.25 and #6.10(63(uint)) to CBOR Sequence, but only inside array<a href="#section-3-35" class="pilcrow">¶</a></p>
<p id="section-3-36">This is in fact just another way to write #6.10(#6.24(h'7C /atom num/') or
  with "5C" for binary string, saving a byte for atom numbers less than 65536
  and having additional benefits:<a href="#section-3-36" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-37.1">
          <p id="section-3-37.1.1">simplified encoders/decoders may operate on single atoms rather than deep
scanning of strings concatenated from pieces<a href="#section-3-37.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-37.2">
          <p id="section-3-37.2.1">a tag with a number is more readable in Diagnostic Notation than binary
string with a prefix and varint<a href="#section-3-37.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-3-38">==probably remove this:
  And last use of Tag #6.10 is on undefined as map key (that is, two bytes
  0xDA 0xF7), where map's value for such key is array for dictionary setup
  (that is, in which CBAR member is null). It is described later in section
  on nesting decitionaries.
==/probably remove<a href="#section-3-38" class="pilcrow">¶</a></p>
<p id="section-3-39">A tag #6.10 on map with Alternatives Tag (121+) defines a "namespace" where
  another dictionary is used - that is, it allows for multiple dictionaries
  in one message, on different level (think of JSON-lD's "@context"). Recall
  image above:<a href="#section-3-39" class="pilcrow">¶</a></p>
<p id="section-3-40"><code>js
   {                      ; level 1 - default dictionary
     [                    ; level 2
       #6.10(#6.123({     ; level 3 uses dictionary numer 3
               #6.10(1),  ; expanded to "foobar"
               ...
             })),
             #6.10(s2),   ; level 2 again
             #6.10(1),    ; expanded to "quux"
</code><a href="#section-3-40" class="pilcrow">¶</a></p>
<p id="section-3-41">The same is for arrays, but to distinguish from dictionary setup, using
  #6.10 on namespace as array <span class="bcp14">MUST</span> always have Alternative (e.g. #6.121 for
  default 0), and dictionary setup <span class="bcp14">MUST NOT</span> have an Alternative Tag on it.<a href="#section-3-41" class="pilcrow">¶</a></p>
<p id="section-3-42">All other uses of Tag #6.10 are reserved for future use and <span class="bcp14">MUST NOT</span> be
  emitted by conforming encoders for now version.<a href="#section-3-42" class="pilcrow">¶</a></p>
<p id="section-3-43">## Dictionary setup - tag #6.10 on array<a href="#section-3-43" class="pilcrow">¶</a></p>
<p id="section-3-44">Tag #6.10 always sets up dictionary for use later in stream. It may have
  CBAR member (last or before checksum), which is then expanded using this
  dictionary and substituted in place of entire tagged array - or CBAR member
  may be null, meaning this is just dictionary setup for later use (e.g. on
  individual bytestrings or integers, see examples above). In any case, tagged
  array is "cutted" from unpacked CBOR, as if were not existing - thus
  preferred place for dictionary is at top-level CBOR Sequence (level 0 on the
  messages diagram above).<a href="#section-3-44" class="pilcrow">¶</a></p>
<p id="section-3-45">Dictionary setup can be in two forms: simple and full. Simple is:<a href="#section-3-45" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-46">
<pre>
#6.10([atoms, bytedict, CBAR, ? checksum])
</pre><a href="#section-3-46" class="pilcrow">¶</a>
</div>
<p id="section-3-47">Where <code>atoms</code> is array explicitly assigning atom in dictionary by index in
  array - first, i.e. index 0 is array, is atom 0, then atom 1 and so on.<a href="#section-3-47" class="pilcrow">¶</a></p>
<p id="section-3-48">Full form instead of <code>atoms</code> array and <code>bytedict</code>  consists of commands and
  their arguments, occuping everything till CBAR (and possibly checksum)
  members. Commands (opcodes) are single-character strings which have single
  outer array member after them - also an array if more than one argument
  needed. That is, it is like a key-value list (like map), but in array form,
  may have odd number and is processed sequentially.<a href="#section-3-48" class="pilcrow">¶</a></p>
<p id="section-3-49">Rationale: naturally, it could have been a map, but map could have entries
             in any order, so it would require from decoder to 1) buffer
             everything till end of map is seen and start processing only
             then, and 2) some way to reference between map entries, when
             there is more than one operation of same type (that is, requiring
             array under a single map key). Thus, in array form it is possible
             for decoder to process entries immediately as they are seen,
             simplifying implementation and lowering memory requirements,
             while also allowing variable number of parameters per operation.<a href="#section-3-49" class="pilcrow">¶</a></p>
<p id="section-3-50">Full form at last produces an (in-memory) array of strings, which is then
  processed same as array in simple form. Thus, first simple form and overall
  CBAR decoder operation will be described, and then full form in later
  section.<a href="#section-3-50" class="pilcrow">¶</a></p>
<p id="section-3-51"># Details of CBAR operation and simple-form dictionary<a href="#section-3-51" class="pilcrow">¶</a></p>
<p id="section-3-52">VarUInt30 means variable-length unsigned integer capable of holding at
  most 30 bits, by the following bit patterns (from MSB to LSB):
  * 0aaaaaaa                             - 7 bits, values 0..127 coded as-is
  * 100aaaaa bbbbbbbb                    - 13 bits
  * 101aaaaa bbbbbbbb cccccccc           - 21 bits
  * 11aaaaaa bbbbbbbb cccccccc dddddddd  - 30 bits<a href="#section-3-52" class="pilcrow">¶</a></p>
<p id="section-3-53">Rationale: As this compression is targeted primarily towards constrained
             implementations, those supporting more than 32 bits are
             considered unconstrained - that is, e.g. more than 4 Gbytes
             chunks of data. And 2^30 atoms will require 5 Gbytes of memory at
             minimum; for literal lengths 2^30 bytes is also unlikely to
             surpass when other memory from 4 Gbytes is needed for other
             purposes.<a href="#section-3-53" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-54">
<pre>
         However, if discussion will conclude that 60+ bits needed (e.g.
         for unification with YANG SID), alternative VarUInt60 supporting
         60 bits in 8 bytes is posible:

         0..143 values coded as themselves                    bits:
         1001aaaa bbbbbbbb                                     - 12
         1010aaaa bbbbbbbb cccccccc                            - 20
         1011aaaa bbbbbbbb cccccccc dddddddd                   - 28
         1100aaaa bbbbbbbb cccccccc dddddddd eeeeeeee          - 36
         1101aaaa bbbbbbbb cccccccc dddddddd eeeeeee  ffffffff - 44
         1110aaaa bbbbbbbb cccccccc dddddddd   ...    gggggggg - 52
         1111aaaa bbbbbbbb cccccccc dddddddd   ...    hhhhhhhh - 60

         Or even full 64 bits in 9 bytes is possible:

         0..191 values coded as themselves                     bits:
         110aaaaa bbbbbbbb                                     - 13
         1110aaaa bbbbbbbb cccccccc                            - 20
         11110aaa bbbbbbbb cccccccc dddddddd                   - 27
         111110aa bbbbbbbb cccccccc dddddddd eeeeeeee          - 34
         11111100 aaaaaaaa bbbbbbbb cccccccc dddddddd eeeeeeee - 40
         11111101 aaaaaaaa bbbbbbbb cccccccc   ...    ffffffff - 48
         11111110 aaaaaaaa bbbbbbbb cccccccc   ...    gggggggg - 56
         11111111 aaaaaaaa bbbbbbbb cccccccc   ...    hhhhhhhh - 64
</pre><a href="#section-3-54" class="pilcrow">¶</a>
</div>
<p id="section-3-55">Opcodes of <code>IN_BLOB</code> state, with possible <code>&lt;argument N&gt;</code>:<a href="#section-3-55" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-56">
<pre>
C0             - Atom 0
C1             - Atom 1
F5             - Atom 2
F6             - Atom 3
F7             - Atom 4
F8             - Atom 5
F9             - Atom 6
FA             - Atom 7
FB             - Atom 8
FC &lt;VarUInt30&gt; - Copy N Literal bytes, N MUST be greater than 1
FD &lt;VarUInt30&gt; - Decompress (dispense) atom N
FE byte/VInt21 - Escape next byte (Copy 1 literal byte) or Extended functions
FF             - Copy remaining_bytes literal bytes
any other byte - Output this byte
</pre><a href="#section-3-56" class="pilcrow">¶</a>
</div>
<p id="section-3-57">FE code is special: if next byte following has value 0xC0 or more, then it
  is escape - argument is exactly this byte, which is just escaped, or, in
  other words, it is shorter version of FC 01 <code>&lt;escaped_byte&gt;</code>. Otherwise, if
  value is less than 0xC0, then it is treated as VarUInt30 Extended functions
  (see section about them below). However, due to format of VarUInt30, if it's
  first byte is less than 0xC0, then value is limited to 21 bits. Therefore,
  any Extended function <span class="bcp14">MUST</span> have number less than 2097152.<a href="#section-3-57" class="pilcrow">¶</a></p>
<p id="section-3-58">TBD this hard to deal with remaining_bytes, forbid? discuss in section below<a href="#section-3-58" class="pilcrow">¶</a></p>
<p id="section-3-59">Any output operation decrements <code>remaining_bytes</code> variable by the size of
  chunk output, and in well-formed input it <span class="bcp14">MUST</span> not became less than zero.
  If <code>remaining_bytes</code> became zero (0), state is changed to IN_CBOR.<a href="#section-3-59" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-60">
<pre>
Rationale: UTF-8 since it's updated RFC can't encode codepoints higher than
           0x10FFFF, thus bytes higher than 0xF5 can't appear in well-formed
           UTF-8, and 0xC0 and 0xC1 also must not appear in conforming
           UTF-8, thus these bytes could be used inside CBOR Major Type 3
           (string) without escaping(*), as atoms often will be part of text
           strings, not only binary. For applications wanting to trade-off
           performance to compression ratio, every other byte means itself
           which allows to scan contents of text string byte-by-byte, saving
           few bytes - instead, for performance of decoder, FC code with
           length should be used, allowing to skip to next code.

           (*) This, of course, means not raw CBOR text strings (where such
           bytes are prohibited) but substrings of CBAR which will become
           valid CBOR data items after atom substitutions.
</pre><a href="#section-3-60" class="pilcrow">¶</a>
</div>
<p id="section-3-61">Opcodes of <code>IN_CBOR</code> state, with <code>&lt;arguments&gt;</code> (and (mnemonics)):<a href="#section-3-61" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-62">
<pre>
1C &lt;3 bytes&gt;   - (terCio) Output 1A 00 &lt;3 bytes&gt;
1D             - Atom 0
1E             - Atom 1
1F &lt;5 bytes&gt;   - (Five) Output 1B 00 00 00 &lt;5 bytes&gt;
3C &lt;3 bytes&gt;   - (terCio) Output 3A 00 &lt;3 bytes&gt;
3D             - Atom 2
3E             - Atom 3
3F &lt;5 bytes&gt;   - Five-integer: Output 3B 00 00 00 &lt;5 bytes&gt;
5C &lt;VarUInt30&gt; - Convert atom N to binary string
5D             - Atom 4
5E             - Atom 5
7C &lt;VarUInt30&gt; - Convert atom N to text string
7D             - Atom 6
7E             - Atom 7
9C             - Atom 8
9D             - Atom 9
9E             - Atom 10
BC             - Atom 11
BD             - Atom 12
BE             - Atom 13
DC             - Atom 14
DD             - Atom 15
DE             - Atom 16
DF             - Atom 17
FC &lt;VarUInt30&gt; - Copy N Literal bytes, N MUST be greater than 1
FD &lt;VarUInt30&gt; - Decompress (dispense) atom N, N&gt;17
FE &lt;VarUInt30&gt; - Extended functions
</pre><a href="#section-3-62" class="pilcrow">¶</a>
</div>
<p id="section-3-63">Decoder in IN_CBOR state expects same codepoints as in standard-conformant
  CBOR, plus actions from the table above. That is, on every standard element,
  it's length analyzed, and, for all opcodes except strings, corresponding
  number of bytes is output without interpreting - that is, these opcodes are
  meaningful only at start of CBOR element, or compressed substitution of that
  element, and not significant inside them (as in CBOR itself). Note that
  "opcode" here means initial byte, so that only initial byte and header
  (possibly up to 8 next bytes) are meant here, e.g. for map with two pairs
  single A2 byte is output, not entire structural contents of the map.<a href="#section-3-63" class="pilcrow">¶</a></p>
<p id="section-3-64">For standard CBOR text and byte strings opcodes, after output of element
  header, decoder initializes <code>remaining_bytes</code> variable to length of element
  contents and switches to IN_BLOB state with other opcode set, leaving it
  back to IN_CBOR state when element is finished.<a href="#section-3-64" class="pilcrow">¶</a></p>
<p id="section-3-65">For example, consider text string "foobarbaz1foobarbaz2foobarquux". It has
  CBOR encoding - original uncompressed text - as:<a href="#section-3-65" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-66">
<pre>
78 1E 666F6F62617262617A 31 666F6F62617262617A 32 666F6F62617271757578
</pre><a href="#section-3-66" class="pilcrow">¶</a>
</div>
<p id="section-3-67">(here spaces around "1" and "2" for better readability of text below)<a href="#section-3-67" class="pilcrow">¶</a></p>
<p id="section-3-68">Suppose atom number 20 has value "foobarbaz" and atom number 3 value
  "foobarquux". Then in CBAR form it will be:<a href="#section-3-68" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-69">
<pre>
78 1E  FD 14  31  FD 14  31  3E
</pre><a href="#section-3-69" class="pilcrow">¶</a>
</div>
<p id="section-3-70">Here, decoder sees standard CBOR prologue of 30-byte text string, outputs
  it, initializes <code>remaining_bytes</code> variable to 30 (0x1e) and goes to IN_BLOB
  state. Then it sees FD command to output atom, which argument is 0x14,
  decimal 20 (in our example numbers are small enough for VarInt to fit in
  a byte). It outputs contents of atom 20, and decrements <code>remaining_bytes</code> by
  length of atom, 9. Then it sees plain 0x31 byte, outputs it, decrementing
  <code>remaining_bytes</code> by 1. Process repeats with next atom and byte 0x32.
  Finally, there is 0x3E, short single-byte opcode for atom 3, which is output
  and <code>remaining_bytes</code> variable reaches 0 as length of atom 3 matches it. So
  decoder exit IN_BLOB state and expects start of next CBOR element after this
  string.<a href="#section-3-70" class="pilcrow">¶</a></p>
<p id="section-3-71">Note that FC and FD opcodes are same in both states. This is two-fold: it
  allows CBAR to skip over (copy as is) new CBOR opcodes, conflicting with
  CBAR, if such will appear in the future, and - more importantly - it allows
  to paste atoms or literals as CBOR fragments. For example, this allows for
  CBOR sequences or copying incomplete CBOR structures, like fragments of
  unclosed (unfinished) arrays or maps. It is possible because on each step,
  decoder do not check CBOR to be structurally valid (though it <span class="bcp14">SHOULD</span> do so
  for final document) - it just expects next CBOR element and nothing more.<a href="#section-3-71" class="pilcrow">¶</a></p>
<p id="section-3-72">Opcodes 5C and 7C used for "type conversion": as atoms are binary strings,
  often it's common for entire CBOR element to consist of single atom. In this
  case, specifying length and then going to IN_BLOB state emits more bytes and
  processing, because length of atom is already known. Thus, e.g. 7C and atom
  number is converted on output to proper CBOR element header of atom length,
  folowed by atom contents. For example, if atom 13 is "outputData", then
  7C 0D is expanded to 6A 6F 75 74 70 75 74 44 61 74 - 6A corresponds to
  length of 10 bytes of atom contents in standard CBOR Major Type 3.<a href="#section-3-72" class="pilcrow">¶</a></p>
<p id="section-3-73">Tag #6.10 may be applied not only to entire array (which is logically
  substituted to enclosing CBOR after uncompressing) but also to binary
  string. This is used for two purposes, however with the same implementation
  code. First is standalone #6.10 in CBOR stream - in this case, it is assumed
  that dictionary was setup earlier, either in the CBOR stream or by external
  application means, e.g. media type. That is, it is equivalent as if the same
  #6.10 with array with same dictionary was substituted in place of this bstr.
  Second purpose is for atom setup table to use previously defined atoms, see
  below.<a href="#section-3-73" class="pilcrow">¶</a></p>
<p id="section-3-74">Dictionary is set up as follows.<a href="#section-3-74" class="pilcrow">¶</a></p>
<p id="section-3-75">If an atom is simple (types 0, 1, 7) CBOR element or structured construct
  (Major Type 4 or 5, e.g. map), then it's content is NOT processed, just used
  as-is: e.g. map encoding including child key-value pairs), or 9 bytes for
  double-size floating point value (0xfb and 8 bytes of IEEE 754). Note that,
  in order to support constrained implementations or implementations above
  a generic encoder/decoder, keeping exact serialization (in addition to
  parsed CBOR tree) can be memory-consuming or impossible to obtain. Thus, as
  possible re-encoding to CBOR, while retaining semantics, may lead to
  different chunk of bytes (e.g. order of map keys or float vs double), it
  <span class="bcp14">SHOULD NOT</span> be relied upon in applications requiring checksums or
  cryptographic signatures (some out-of-band negotiation of whether encoding
  is deterministic may be needed).<a href="#section-3-75" class="pilcrow">¶</a></p>
<p id="section-3-76">If an atom is of Major Type 2 or 3, then only contents of this string is
  used, e.g. 4 hex bytes 63 666F6 of CBOR text string "foo" will result
  in 3-byte atom 666F6. However if an atom is bstr (Major Type 2) with tag
  #6.10, then it's contents processed (and expanded value then used) by the
  same CBAR unpacking process - but decoder start state is IN_BLOB (instead of
  IN_CBOR for main CBAR) with <code>remaining_bytes</code> initialized to infinity and
  error on premature end of input is suppressed. Atoms allowed inside decoding
  such atom are only those atoms defined earlier in this dictionary array.
  Decoder, however, may be told to start in IN_CBOR state if the bstr has
  additionally tag 24 or 63 (encoded CBOR or CBOR Sequence).<a href="#section-3-76" class="pilcrow">¶</a></p>
<p id="section-3-77">Note that title says "and generic BLOB" - that is, tag #6.10 an a string
  without tag 24 or 63 is not decoded to CBOR or CBOR sequence after unpacking
  but left as just expanded string - for applications which want compression
  only on some their BLOBs, not structurally. It may be point of view that an
  atom with both tags 10 and 63 is exception as decoded sequence is NOT
  substituted as several elements of atoms array - but better view in
  implementation that atoms after expanding are immediately entered into
  internal table, in contrast to CBOR stream, where expanded contents is then
  fed to generic CBOR decoding process.<a href="#section-3-77" class="pilcrow">¶</a></p>
<p id="section-3-78">#### Extended functions<a href="#section-3-78" class="pilcrow">¶</a></p>
<p id="section-3-79">These are currently defined only for numbers 121-127 and 1280-1400, to be
  on par with Alternatives Tags encoding. But in contrast to using tags on
  structural CBOR elements, inside binary string these extended functions just
  switch dictionaries without keeping state - and tags do "push" and "pop" on
  stack levels.<a href="#section-3-79" class="pilcrow">¶</a></p>
<p id="section-3-80">### Examples<a href="#section-3-80" class="pilcrow">¶</a></p>
<p id="section-3-81">Example from draft-cbor-packed, in higher compression variant (this is not
  quite CBOR diagnostic notation but hex codes for bytes should be familiar):<a href="#section-3-81" class="pilcrow">¶</a></p>
<p id="section-3-82">```
#6.10([                                                            / 2 bytes /
  /atoms/[                                                         / 1 byte  /
    "rgbValue",   #6.10(#2.11 C0 "Red"),  #6.10(#2.13 C0 "Green"),
  / #0 (9 bytes)  #1 (CA 4B C0 52 65 64)  #2 (8 bytes)            = 23 bytes /<a href="#section-3-82" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-83">
<pre>
#6.10(#2.12 C0 "Blue"), "http://192.168.1.10",   / #3 (7 bytes)            #4 (20 bytes)                         = 27 bytes /

#6.10(#2.35 F7 "3:8445/wot/thing")), #6.10(#2.42 F8 "/MyLED/"),   / #5 (CA 58 23 F7 ..-&gt; 20 bytes )      #6 (CA 58 3A F8 ..-&gt; 11 bytes) = 31 /

"name", "@type",  "links",  "href",   "mediaType", "application/json",   / #7 (5 b) #8 (5 b)  #9 (6 b)  #10 (5 b)  #11 (10 b)  #12 (17 b)    = 48 b /

"outputData",   "valueType",    "type",        "writable",   / #13 (11 bytes)  #14 (10 bytes)  #15 (5 bytes)  #16 (9 bytes)   = 35 bytes/

#6.10(#6.63(#2.18 "outputData": { "valueType": { "type": "number" } } )),   / #17 (CA D83F 52 6A FD0D A1 49 FD0E A1 44 FD0F 46 6E756D626572 -&gt; 22 b) /

["Property"],                 "colorTemperatureChanged",   / #18 (81 48 68 ..-&gt; 10 bytes)  #19 (24 bytes)                  = 34 bytes /   ],                                              / -&gt; 220 bytes of contents /   /bytedict/"",                                                   / = 1 byte /   /CBAR/#2.308&lt;                                                  / = 3 bytes /   / { "name": "MyLED",       "interactions":              [      / 9+13+1    /
A6 7C 07   65 4D794C4544  6C 696E746572616374696F6E73 86     / = 23 bytes/
</pre><a href="#section-3-83" class="pilcrow">¶</a>
</div>
<p id="section-3-84">/ {  "links": [  {  "href": "http://192.../rgbValueRed"         = 11 bytes /
    A5 7C 09    81 A2 7C 0A   78 35 F9       C1
  / "mediaType": "application/json" } ]                           =  4 bytes /
    7C 0B        7C 0C
  / "outputData": { "valueType": { "type": "number" } },          =  2 bytes /
    FD 11
  / "name": "rgbValueRed", "writable": true,                      =  7 bytes /
    7C 05   7C 01          7C 10       F5
  / "@type": ["Property"] },                                      =  4 bytes /
    7C 08    FD 12<a href="#section-3-84" class="pilcrow">¶</a></p>
<p id="section-3-85">/ {  "links": [  {  "href": "http://192.../rgbValueGreen"       = 11 bytes /
    A5 7C 09    81 A2 7C 0A   78 37 F9       F5
  / "mediaType": "application/json" } ]                           =  4 bytes /
    7C 0B        7C 0C
  / "outputData": { "valueType": { "type": "number" } },          =  2 bytes /
    FD 11
  / "name": "rgbValueGreen", "writable": true,                    =  7 bytes /
    7C 05   7C 02            7C 10       F5
  / "@type": ["Property"] },                                      =  4 bytes /
    7C 08    FD 12<a href="#section-3-85" class="pilcrow">¶</a></p>
<p id="section-3-86">/ {  "links": [  {  "href": "http://192.../rgbValueBlue"        = 11 bytes /
    A5 7C 09    81 A2 7C 0A   78 37 F9       F6
  / "mediaType": "application/json" } ]                           =  4 bytes /
    7C 0B        7C 0C
  / "outputData": { "valueType": { "type": "number" } },          =  2 bytes /
    FD 11
  / "name": "rgbValueBlue", "writable": true,                     =  7 bytes /
    7C 05   7C 03           7C 10       F5
  / "@type": ["Property"] },                                      =  4 bytes /
    7C 08    FD 12<a href="#section-3-86" class="pilcrow">¶</a></p>
<p id="section-3-87">/ {  "links": [  {  "href": "http://192.../rgbValueWhite"       = 16 bytes /
    A5 7C 09    81 A2 7C 0A   78 37 F9       C0 5768697465
  / "mediaType": "application/json" } ]                           =  4 bytes /
    7C 0B        7C 0C
  / "outputData": { "valueType": { "type": "number" } },          =  2 bytes /
    FD 11
  / "name": "rgbValueWhite",        "writable": true,             = 14 bytes /
    7C 05   6D C0 FC 05 5768697465  7C 10       F5
  / "@type": ["Property"] },                                      =  4 bytes /
    7C 08    FD 12<a href="#section-3-87" class="pilcrow">¶</a></p>
<p id="section-3-88">/ {  "links": [  {  "href": "http://192.../ledOnOff"            = 20 bytes /
    A5 7C 09    81 A2 7C 0A   78 32 F9    FC 08 6C65644F6e4F6666
  / "mediaType": "application/json" } ]                           =  4 bytes /
    7C 0B        7C 0C
  / "outputData": { "valueType": { "type": "boolean" } }          = 16 bytes /
    7C 0D        A1  7C 0E      A1 7C 0F  67 626F6F6C65616E
  / "name": "ledOnOff",         "writable": true,                 = 14 bytes /
    7C 05   68 6C65644F6e4F6666  7C 10       F5
  / "@type": ["Property"] },                                      =  4 bytes /
    7C 08    FD 12<a href="#section-3-88" class="pilcrow">¶</a></p>
<p id="section-3-89">/ {  "links": [  {  "href": "http:/.../colorTemperatureChanged" = 12 bytes /
    A5 7C 09    81 A2 7C 0A   78 41 F9   FD 13
  / "mediaType": "application/json" } ]                           =  4 bytes /
    7C 0B        7C 0C
  / "outputData": { "valueType": { "type": "number" } },          =  2 bytes /
    FD 0D
  / "name": "colorTemperatureChanged", "writable": true,          =  7 bytes /
    7C 05   7C 13                      7C 10       F5
  / "@type": [ "Event"         ] },                               =  9 bytes /
    7C 08    81 65 4576656E74<a href="#section-3-89" class="pilcrow">¶</a></p>
<p id="section-3-90">/ "@type": "Lamp",      "id":   "0",                            = 12 bytes /
    7C 08    64 4C616D70  62 6964 61 30
  /  "base":      "http://192.168.1.103:8445/wot/thing",          =  7 bytes /
    64 62617365   7C F8  /FIXME/
  / "@context":                                                   =  9 bytes /
    68 40636F6E74657874
  / "http://192.168.1.102:8444/wot/w3c-wot-td-context.jsonld"     = 41 bytes /
    78 37 F7            FC 24 323A383434342F...6F6E6C64
  &gt;                                               / -&gt; 308 bytes of contents /
])
```<a href="#section-3-90" class="pilcrow">¶</a></p>
<p id="section-3-91">for a 2+1+220+1+3+308 = 535 bytes total, which could be reduced to 529 by
  eliminating three FC xx codes (left for demonstration).<a href="#section-3-91" class="pilcrow">¶</a></p>
<p id="section-3-92">#### Explanation of selected moments in this example<a href="#section-3-92" class="pilcrow">¶</a></p>
<p id="section-3-93">Let's see for first items of atoms table (there is single table in CBAR
  instead of shared/argument split):<a href="#section-3-93" class="pilcrow">¶</a></p>
<p id="section-3-94">#6.10([                                                         / 2 bytes /
    /atoms/[                                                      / 1 byte  /
      "rgbValue",   #6.10(#2.11 C0 "Red"),  #6.10(#2.13 C0 "Green"),
    / #0 (9 bytes)  #1 (CA 4B C0 52 65 64)  #2 (8 bytes)         = 23 bytes /<a href="#section-3-94" class="pilcrow">¶</a></p>
<p id="section-3-95">here you see for index #1 bytes in parentheses corresponding to string
  "rgbValueRed" - the #6.10 tag is 0xCA, then 0x4B is CBOR's Major Type 2 of
  lenth 11 - that's what "rgbValueRed" will have in uncompressed form. Then
  0xC0 refers to Atom 0 - like <code>simple(0)</code> for cbor-packed would be. It is
  taken, then 0x52 0x65 0x64 are ASCII for "Red" - here is trick for IN_BLOB
  state each byte not being a command just means itself. The "correct" sequence
  would be FC 03 52 65 64 - FC for "copy literal", then 03 bytes, then bytes
  themselves - but here we trade off speed (going i++ byte-by-byte) for size,
  saving 2 bytes.<a href="#section-3-95" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-96">
<pre>
#6.10(#2.12 C0 "Blue"), "http://192.168.1.10",   / #3 (7 bytes)            #4 (20 bytes)                         = 27 bytes /

#6.10(#2.35 F7 "3:8445/wot/thing")), #6.10(#2.42 F8 "/MyLED/"),   / #5 (CA 58 23 F7 ..-&gt; 20 bytes )      #6 (CA 58 3A F8 ..-&gt; 11 bytes) = 31 /
</pre><a href="#section-3-96" class="pilcrow">¶</a>
</div>
<p id="section-3-97">Atom 4 (<code>simple(4)</code> for cbor-packed) is encoded as 0xF7 while IN_BLOB state,
  other is same: 0x58 0x23 is just CBOR Major Type 2 for 35 bytes, but it's not
  interpreted as CBOR because state is IN_BLOB - so here it is those "just
  template in a bytestream".<a href="#section-3-97" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-98">
<pre>
"name", "@type",  "links",  "href",   "mediaType", "application/json",   / #7 (5 b) #8 (5 b)  #9 (6 b)  #10 (5 b)  #11 (10 b)  #12 (17 b)    = 48 b /
</pre><a href="#section-3-98" class="pilcrow">¶</a>
</div>
<p id="section-3-99">everything is simple here.<a href="#section-3-99" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3-100">
<pre>
"outputData",   "valueType",    "type",        "writable",   / #13 (11 bytes)  #14 (10 bytes)  #15 (5 bytes)  #16 (9 bytes)   = 35 bytes/

#6.10(#6.63(#2.18 "outputData": { "valueType": { "type": "number" } } )),   / #17 (CA D83F 52 6A FD0D A1 49 FD0E A1 44 FD0F 46 6E756D626572 -&gt; 22 b) /
</pre><a href="#section-3-100" class="pilcrow">¶</a>
</div>
<p id="section-3-101">Here more interesting entry. #6.63 after #6.10 switches to IN_CBOR state (and
  enables consistency checking if decoder implements it). CA D83F 52 is just
  both tags and start of bstr where all following lives. 0x6A is
  for CBOR Major Type 3 of length 10. Then 0xFD 0x0D tells
  to do Atom 0x0d, that is, "outputData" at index 13 decimal. 0xA1 is usual CBOR
  Map of one pair for outer {}, then 0x49 is string in which Atom 0x0E expands
  to "valueType", inner 0xA1 map, "type" by Atom 0x0F=15, and finally "number"
  goes as is in CBOR, with it's 0x46 leading byte and ASCII ones.<a href="#section-3-101" class="pilcrow">¶</a></p>
<p id="section-3-102">Now, final CBOR document wrappend in one 308-byte bstr:<a href="#section-3-102" class="pilcrow">¶</a></p>
<p id="section-3-103">/CBAR/#2.308&lt;                                                  / = 3 bytes /
  / { "name": "MyLED",       "interactions":              [      / 9+13+1    /
    A6 7C 07   65 4D794C4544  6C 696E746572616374696F6E73 86     / = 23 bytes/<a href="#section-3-103" class="pilcrow">¶</a></p>
<p id="section-3-104">/ {  "links": [  {  "href": "http://192.../rgbValueRed"         = 11 bytes /
    A5 7C 09    81 A2 7C 0A   78 35 F9       C1<a href="#section-3-104" class="pilcrow">¶</a></p>
<p id="section-3-105">Note that it uses the same code already shown for atom table setup entries
  above - just that, by definition, here decoder starts IN_CBOR state without
  explicit tagging. And in this state set of opcodes differs, extending standard
  CBOR ones: e.g. 0x7C is like 0x78..0x7B of standard CBOR, but means "convert
  to such string value of that atom" - atom 7 in our case. As length of Atom is
  known because value is known - "name" has length 4, so 0x64 and ASCII "name"
  will be decoded.<a href="#section-3-105" class="pilcrow">¶</a></p>
<p id="section-3-106">Final element on this quote demonstrate IN_CBOR/IN_BLOB state switching. After
  decoding you'll get "http://192.168.1.103:8445/wot/thing/MyLED/rgbValueRed" -
  this is 0x35 bytes, so you see standard CBOR Major Type 3's 0x78 35 beginning
  here. Now, decoder understands this is CBOR string and initializes
  <code>remaining_bytes</code> variable to 0x35, going to IN_BLOB state. Here it sees 0xF9
  meaning Atom 6 - which expands to "http://192.168.1.103:8445/wot/thing/MyLED/"
  and <code>remaining_bytes</code> is decremented by it's length. Now 0xC1 means Atom 1,
  also decrements variable - it reaches 0, so decoder switches again to IN_CBOR
  state. And so on...<a href="#section-3-106" class="pilcrow">¶</a></p>
<p id="section-3-107">TODO non-high-compression but "encoder-implementation-friendly" variant for at
most 1 atom per string (repeated strings only), with additional LZ pass
- and with full form dict<a href="#section-3-107" class="pilcrow">¶</a></p>
<p id="section-3-108">TBD 20.12.24 another variant tag 0xFC Fast Compressable: strings have VarInt64
instead of contents, which is moved to separate strings section, where used as
offset into it, with offset threshold to be possible to <code>mmap()</code> common
dictionary on many documents; or VarInt64 may be other identificator, e.g.
<code>rowid</code> of text/BLOB in database where this document resides<a href="#section-3-108" class="pilcrow">¶</a></p>
<p id="section-3-109">for map merging, tag 63 Encoded CBOR Sequence may be used,
cbor-records 57342-57599 also instead of tag 114
- 24.01.25 Alan DeKok suggests both may be used, not quite replacement<a href="#section-3-109" class="pilcrow">¶</a></p>
<p id="section-3-110">TODO<a href="#section-3-110" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-4">
      <h2 id="name-security-considerations">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-4-1">TODO Security<a href="#section-4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana-considerations">
<section id="section-5">
      <h2 id="name-iana-considerations">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-5-1">This document registers Tag 10.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">TODO<a href="#section-5-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sec-normative-references">
<section id="section-6">
      <h2 id="name-normative-references">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
      </h2>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
      <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
    <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">TODO acknowledge.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-address">
<a href="#name-authors-address" class="section-name selfRef">Author's Address</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Vadim Goncharov</span></div>
<div dir="auto" class="left"><span class="org">Consultant</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:vadimnuclight@gmail.com" class="email">vadimnuclight@gmail.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
